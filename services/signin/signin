#!/usr/local/bin/nush
(load "AgentHTTP")
(load "AgentCrypto")
(load "AgentMongoDB")

(macro redirect (location)
       `(progn (RESPONSE setStatus:303)
               (RESPONSE setValue:,location forHTTPHeader:"Location")
               "redirecting"))

(set PASSWORD_SALT "agent.io")

(class NSString
 (- (id) md5HashWithSalt:(id) salt is
    (((self dataUsingEncoding:NSUTF8StringEncoding)
      agent_hmacMd5DataWithKey:(salt dataUsingEncoding:NSUTF8StringEncoding))
     agent_hexEncodedString)))

(macro get-user (REQUEST)
       `(progn (set screen_name nil)
               (set session nil)
               (if (set token ((,REQUEST cookies) session:))
                   (set mongo (AgentMongoDB new))
                   (mongo connect)
                   (set session (mongo findOne:(dict token:token) inCollection:"accounts.sessions"))
                   (set screen_name (session username:)))
               session))

(macro authenticate ()
       '(progn (get-user REQUEST)))

;; A class for managing user-identifying cookies.
(class AgentHTTPCookie is NSObject
 
 (+ (id) cookieWithName:(id) name value:(id)value is
    ((self alloc) initWithName:name value:value expiration:(NSDate dateWithTimeIntervalSinceNow:3600)))
 
 (- (id) initWithName:(id) name value:(id) value expiration:(id) expiration is
    (super init)
    (set @name name)
    (set @value value)
    (set @expiration expiration)
    (set @stringValue nil)
    self)
 
 (- (id) description is
    "cookie=#{@name} path=\"/\" value=#{@value} expiration=#{(@expiration agent_rfc1123String)}")
 
 ;; Get a string value for a cookie suitable for inclusion in a response header.
 (- (id) stringValue is "#{@name}=#{@value}; path=\/; Expires:#{(@expiration agent_rfc1123String)};"))

;;;;;

;; local signin

(macro signin-form (username password message)
       `(progn (htmlpage "Sign In"
                         (&div class:"row"
                               (&div class:"medium-6 medium-centered columns"
                                     (&form method:"post"
                                            action:"/signin/"
                                            (&fieldset (&legend ,message)
                                                       (&label for:"username" "Username "
                                                             style:"margin-right:2em"
                                                               (&input id:"username"
                                                                     type:"text"
                                                                    width:20
                                                                     name:"username"
                                                                    title:"username"
                                                                    value:,username))
                                                       (&label for:"password" "Password "
                                                             style:"margin-right:2em"
                                                               (&input id:"password"
                                                                     type:"password"
                                                                    width:20
                                                                     name:"password"
                                                                    title:"password"
                                                                    value:,password))
                                                       (&button class:"button tiny"
                                                                 type:"submit"
                                                                "&nbsp;Sign in&nbsp;"))))))))

(get "/signin"
     (authenticate)
     (if screen_name
         (then (redirect "/accounts"))
         (else (signin-form "" "" "Hello!"))))

(post "/signin"
      (set mongo (AgentMongoDB new))
      (mongo connect)
      (REQUEST setContentType:"text/html")
      (set ip-address ((REQUEST headers) "X-Forwarded-For"))
      (set username ((REQUEST post) "username"))
      (set password ((REQUEST post) "password"))
      (NSLog ((REQUEST post) description))
      (cond ((or (not username) (not password))
             (set message "Missing username or password. Try that again.")
             (signin-form username password message))
            ((set account (mongo findOne:(dict username:username
                                               password:(password md5HashWithSalt:PASSWORD_SALT))
                            inCollection:"accounts.users"))
             
             (unless (set SESSIONTOKEN ((REQUEST cookies) session:))
                     (set SESSIONTOKEN ((AgentUUID new) stringValue))
                     (set sessionCookie (AgentHTTPCookie cookieWithName:"session" value:SESSIONTOKEN))
                     (RESPONSE setValue:(sessionCookie stringValue) forHTTPHeader:"Set-Cookie"))
             
             (set session (dict account_id:(account _id:) username:username token:SESSIONTOKEN))
             (mongo updateObject:session
                    inCollection:"accounts.sessions"
                   withCondition:(dict account_id:(account _id:))
               insertIfNecessary:YES
           updateMultipleEntries:NO)
             (RESPONSE redirectResponseToLocation:"/accounts"))
            (else (set message "We didn't recognize that username and password.")
                  (signin-form username password message))))

(macro htmlpage (title *body)
       `(&html class:"no-js" lang:"en"
               (&head (&meta charset:"utf-8")
                      (&meta name:"viewport" content:"width=device-width, initial-scale=1.0")
                      (&meta name:"description" content:"My Agent on the Internet")
                      (&meta name:"keywords" content:"agent,personal")
                      (&meta name:"author" content:"Tim Burks")
                      (&title ,title)
                      (&link rel:"stylesheet" href:"/foundation-5/css/foundation.min.css")
                      (&script src:"/foundation-5/js/vendor/modernizr.js"))
               (&body (&div class:"contain-to-grid" style:"margin-bottom:20px;" (&nav class:"top-bar" data-topbar:1))
                      ,@*body
                      ;(&script src:"/foundation-5/js/vendor/jquery.js")
                      ;(&script src:"/foundation-5/js/foundation.min.js")
                      ;(&script "$(document).foundation();")
                      )))

(get "/*path:"
     (authenticate)
     (RESPONSE setStatus:404)
     (htmlpage "Not found"
               (&div class:"row"
                     (&div class:"large-12 columns"
                           (&h3 "404 Resource Not Found")
                           (&p "You wanted: #{*path}")
                           (&p "Sorry.")))))

(NSLog "signin START")
(AgentHTTPServer run)

